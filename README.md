# 治疗方案管理系统

一个用于管理和搜索医疗治疗方案的Web应用程序，支持Excel文件上传、数据分析和治疗卡片生成。

## 功能特点

- 用户认证与授权系统
- Excel模板下载与上传
- 治疗方案数据提取与分析
- 治疗卡片自动生成
- 基于关键词的搜索功能（支持按疾病、方案名称等搜索）
- 风险分级与评估
- 响应式Web界面

## 技术栈

- **后端**: Python, Flask, Flask-RESTful, PyMongo
- **数据库**: MongoDB
- **认证**: JWT (JSON Web Tokens)
- **前端**: HTML, CSS, JavaScript, Bootstrap
- **数据处理**: Pandas, Openpyxl

## 环境要求

- Python 3.8+
- MongoDB 4.4+
- 现代浏览器

## 安装与设置

### 使用Git克隆

```bash
git clone https://github.com/your-username/therapy-management-system.git
cd therapy-management-system
```

### 创建虚拟环境并安装依赖

```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# Linux/Mac
source venv/bin/activate

# 安装依赖
pip install -r requirements.txt
```

### 环境变量配置

创建一个`.env`文件，包含以下内容：

```
MONGO_URI=mongodb://localhost:27017/therapy_db
JWT_SECRET_KEY=your_secret_key
TEMPLATES_FOLDER=templates
UPLOADS_FOLDER=uploads
DEBUG=True
```

### 数据库准备

确保MongoDB服务已启动，系统会自动创建必要的数据库和集合。

## 运行应用

```bash
# 使用自动启动脚本(推荐)
bash start_server.sh

# 或直接运行
python app.py
```

服务默认运行在 http://localhost:5000

## API接口说明

### 1. 用户注册
- **URL**: `/api/register`
- **方法**: POST
- **数据格式**: JSON
```json
{
    "username": "用户名",
    "password": "密码",
    "email": "邮箱"
}
```

### 2. 用户登录
- **URL**: `/api/login`
- **方法**: POST
- **数据格式**: JSON
```json
{
    "username": "用户名",
    "password": "密码"
}
```

### 3. 下载模板
- **URL**: `/api/template`
- **方法**: GET
- **认证**: 不需要

### 4. 上传文件
- **URL**: `/api/upload`
- **方法**: POST
- **认证**: 需要JWT Token
- **数据格式**: Form-data
  - key: file
  - value: Excel文件数据

### 5. 生成治疗卡片
- **URL**: `/api/generate-card`
- **方法**: POST
- **认证**: 需要JWT Token
- **数据格式**: JSON
```json
{
    "file_id": "文件ID"
}
```

### 6. 搜索治疗卡片
- **URL**: `/api/search-cards`
- **方法**: GET
- **认证**: 需要JWT Token
- **参数**:
  - keyword: 搜索关键词（方案名称、疾病名称等）
  - page: 页码（默认1）
  - limit: 每页数量（默认10）

## 认证说明

除了注册和登录接口，其他所有接口都需要在请求头中包含JWT Token：

```
Authorization: Bearer <your_token>
```

## 模板说明

系统使用Excel模板收集治疗方案信息，包括以下字段：

- 基础信息: 来源、疾病、方案名称、方案简介、治疗时间、费用范围
- 疗效数据: 总人数、有效人数、临床治愈人数、未复发人数、有效率、临床治愈率、未复发率
- 风险信息: 一级风险表现、二级风险表现、三级风险表现、风险概率和、风险评级
- 评分信息: 受益评级、便利度评级、受益评分、风险评分、便利度评分
##各维度的评级算法及数据来源
1. 受益：高、中、低
2. 风险：高、中、低
3. 治疗总时间：长期、中期、短期
4. 费用：
   - 总费用
   - 单月费用
5. 便利度：高、中、低

一、治疗
（一）受益评分流程
1. 提取治疗方案、疗效标准、有效率（总有效率）、临床治愈率（显效率或治愈率）、未复发率（1-复发率）、有效人数、临床治愈人数、未复发人数、总人数。
2. 计算评分 = (有效率×2 + 临床治愈率×3 + 未复发率×5) × log(人数)
3. 根据绝对阈值进行评分：
   - 高收益：评分 > 8分
   - 中受益：8分 > 评分 > 3分
   - 低受益：评分 < 3分

（二）风险评估
1. 搜索相关数据收集可能的风险及其发生率
2. 根据风险的具体表现进行分级和赋值
3. 医疗损伤通常根据严重程度分为三个等级

（三）风险等级
1. **一级风险** 风险权重 = 2
   - **定义**：轻微不适或短暂功能障碍，通常无需特殊治疗，可自行恢复。
判断关键是否可恢复  
   - **例子**：轻微药物过敏、短暂疼痛或局部红肿。。

3.**二级风险**  风险权重=5
定义：导致患者部分器官或系统功能受损，需要较长时间治疗或康复，可能遗留一定程度后遗症- 
判断要点：是否留有可能后遗症，只要有可能留有后遗症就为三级风险
补充：手术的后会有疤痕或出血
**例子**：严重感染、器官损伤或手术并发症导致长期功能障碍。

4. **三级风险**  风险权重=10
   - **定义**：极其严重的损伤，可能导致永久残疾、器官衰竭或生命危险。  
判断要点：只要有可能危及生命或重大损伤即可认定为极重风险
   - **例子**：重大医疗事故、严重药物毒性反应或不可逆的器官损伤。

一级风险：权重 = 2
二级风险：权重 = 5
三级风险：权重 = 10
计算风险评分=∑(风险发生率×风险权重)
根据评分进行分级，高风险：评分>5,中风险：3<评分<5,低风险：评分<3,注：手术后出血和疤痕都至少为中风险，出血必然需要干预且发生率100%
三、时间数据收集
0.治疗总时长：诊断，治疗，养护，后期监测及注意
1.单次治疗时间：治疗一次所需要花费的时间=
2治疗频率
四、治疗总费用
1.是否进医保，如果进医保报销比例是多少，
2.是否疗效付费，
五、便利度
1.根据治疗进行计算得分
操作难度：（复杂的专业技能操作1分，需要培训的简单操作3分，不需要培训的操作5分），
时间成本：（治疗频次*单次时间）单月小于7小时（每日服药三次，每次5分钟一个月需要花7小时服药）5分，单月大于7-14小时4分，14-21小时3分，21-28小时2分，28-35小时1分，35小时以上0分
生活干扰：（严种影响生活1分，可调整3分，影响较低5分）
2计算评分：评分=操作难度+时间成本+生活干扰
3.根据评分进行分级：便利度评分>10高，6<便利度评分<=10中（9-6），便利度评分<=5低

数据来源及大模型运用 
文献，医生经验，病人或病历总结
1 疗效，治疗时间：使用飞书进行论文分析与总结
2风险：使用deepseek进行总结，由人类医生进行审核
3总费用及月费用区间：用大模型回答，数据来源全网
4不便程度：由大模型依据评分算法进行判断

## 开发指南

### 目录结构

- `app.py`: 主应用程序入口和API实现
- `templates/`: 前端HTML模板
- `static/`: 静态资源(CSS, JavaScript等)
- `uploads/`: 用户上传的文件存储位置
- `venv/`: Python虚拟环境
- `requirements.txt`: Python依赖列表

### 添加新功能

1. 在`app.py`中添加新的API路由
2. 更新前端HTML模板
3. 更新测试脚本
4. 更新文档

## 贡献指南

1. Fork本仓库
2. 创建你的功能分支 (`git checkout -b feature/amazing-feature`)
3. 提交你的更改 (`git commit -m 'Add some amazing feature'`)
4. 推送到分支 (`git push origin feature/amazing-feature`)
5. 创建一个Pull Request

## 许可证

本项目采用MIT许可证 - 详见 [LICENSE.md](LICENSE.md) 文件 